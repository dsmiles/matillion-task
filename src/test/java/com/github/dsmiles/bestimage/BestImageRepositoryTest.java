package com.github.dsmiles.bestimage;

import com.github.dsmiles.bestimage.repository.BestImageRepository;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestTemplate;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
public class BestImageRepositoryTest {

    @Mock
    private RestTemplate mockRestTemplate;

    @InjectMocks
    private BestImageRepository bestImageRepository ;

    @Test
    public void testFind_ReturnsData_WhenApiResponseIsSuccessful() {
        String mockApiResponse = "{\"page\":1,\"per_page\":10,\"photos\":[{\"id\":256262,\"width\":2784,\"height\":1848,\"url\":\"https://www.pexels.com/photo/close-up-of-microscope-256262/\",\"photographer\":\"Pixabay\",\"photographer_url\":\"https://www.pexels.com/@pixabay\",\"photographer_id\":2659,\"avg_color\":\"#56433C\",\"src\":{\"original\":\"https://images.pexels.com/photos/256262/pexels-photo-256262.jpeg\",\"large2x\":\"https://images.pexels.com/photos/256262/pexels-photo-256262.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=2\\u0026h=650\\u0026w=940\",\"large\":\"https://images.pexels.com/photos/256262/pexels-photo-256262.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=650\\u0026w=940\",\"medium\":\"https://images.pexels.com/photos/256262/pexels-photo-256262.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=350\",\"small\":\"https://images.pexels.com/photos/256262/pexels-photo-256262.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=130\",\"portrait\":\"https://images.pexels.com/photos/256262/pexels-photo-256262.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=1200\\u0026w=800\",\"landscape\":\"https://images.pexels.com/photos/256262/pexels-photo-256262.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=627\\u0026w=1200\",\"tiny\":\"https://images.pexels.com/photos/256262/pexels-photo-256262.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=1\\u0026fit=crop\\u0026h=200\\u0026w=280\"},\"liked\":false,\"alt\":\"Close-up of Microscope\"},{\"id\":132477,\"width\":4777,\"height\":3166,\"url\":\"https://www.pexels.com/photo/clear-water-drops-132477/\",\"photographer\":\"Anthony \uD83D\uDE42\",\"photographer_url\":\"https://www.pexels.com/@inspiredimages\",\"photographer_id\":37464,\"avg_color\":\"#327694\",\"src\":{\"original\":\"https://images.pexels.com/photos/132477/pexels-photo-132477.jpeg\",\"large2x\":\"https://images.pexels.com/photos/132477/pexels-photo-132477.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=2\\u0026h=650\\u0026w=940\",\"large\":\"https://images.pexels.com/photos/132477/pexels-photo-132477.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=650\\u0026w=940\",\"medium\":\"https://images.pexels.com/photos/132477/pexels-photo-132477.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=350\",\"small\":\"https://images.pexels.com/photos/132477/pexels-photo-132477.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=130\",\"portrait\":\"https://images.pexels.com/photos/132477/pexels-photo-132477.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=1200\\u0026w=800\",\"landscape\":\"https://images.pexels.com/photos/132477/pexels-photo-132477.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=627\\u0026w=1200\",\"tiny\":\"https://images.pexels.com/photos/132477/pexels-photo-132477.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=1\\u0026fit=crop\\u0026h=200\\u0026w=280\"},\"liked\":false,\"alt\":\"Clear Water Drops\"},{\"id\":414860,\"width\":3762,\"height\":3456,\"url\":\"https://www.pexels.com/photo/plasma-ball-illustration-414860/\",\"photographer\":\"Pixabay\",\"photographer_url\":\"https://www.pexels.com/@pixabay\",\"photographer_id\":2659,\"avg_color\":\"#200B18\",\"src\":{\"original\":\"https://images.pexels.com/photos/414860/pexels-photo-414860.jpeg\",\"large2x\":\"https://images.pexels.com/photos/414860/pexels-photo-414860.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=2\\u0026h=650\\u0026w=940\",\"large\":\"https://images.pexels.com/photos/414860/pexels-photo-414860.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=650\\u0026w=940\",\"medium\":\"https://images.pexels.com/photos/414860/pexels-photo-414860.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=350\",\"small\":\"https://images.pexels.com/photos/414860/pexels-photo-414860.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=130\",\"portrait\":\"https://images.pexels.com/photos/414860/pexels-photo-414860.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=1200\\u0026w=800\",\"landscape\":\"https://images.pexels.com/photos/414860/pexels-photo-414860.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=627\\u0026w=1200\",\"tiny\":\"https://images.pexels.com/photos/414860/pexels-photo-414860.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=1\\u0026fit=crop\\u0026h=200\\u0026w=280\"},\"liked\":false,\"alt\":\"Plasma Ball Illustration\"},{\"id\":2280571,\"width\":6016,\"height\":4016,\"url\":\"https://www.pexels.com/photo/person-holding-laboratory-flask-2280571/\",\"photographer\":\"Chokniti Khongchum\",\"photographer_url\":\"https://www.pexels.com/@chokniti-khongchum-1197604\",\"photographer_id\":1197604,\"avg_color\":\"#A5BECD\",\"src\":{\"original\":\"https://images.pexels.com/photos/2280571/pexels-photo-2280571.jpeg\",\"large2x\":\"https://images.pexels.com/photos/2280571/pexels-photo-2280571.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=2\\u0026h=650\\u0026w=940\",\"large\":\"https://images.pexels.com/photos/2280571/pexels-photo-2280571.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=650\\u0026w=940\",\"medium\":\"https://images.pexels.com/photos/2280571/pexels-photo-2280571.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=350\",\"small\":\"https://images.pexels.com/photos/2280571/pexels-photo-2280571.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=130\",\"portrait\":\"https://images.pexels.com/photos/2280571/pexels-photo-2280571.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=1200\\u0026w=800\",\"landscape\":\"https://images.pexels.com/photos/2280571/pexels-photo-2280571.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=627\\u0026w=1200\",\"tiny\":\"https://images.pexels.com/photos/2280571/pexels-photo-2280571.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=1\\u0026fit=crop\\u0026h=200\\u0026w=280\"},\"liked\":false,\"alt\":\"Person Holding Laboratory Flask\"},{\"id\":60582,\"width\":6111,\"height\":4285,\"url\":\"https://www.pexels.com/photo/gray-newton-s-cradle-in-close-up-photogaphy-60582/\",\"photographer\":\"Pixabay\",\"photographer_url\":\"https://www.pexels.com/@pixabay\",\"photographer_id\":2659,\"avg_color\":\"#9EA4AB\",\"src\":{\"original\":\"https://images.pexels.com/photos/60582/newton-s-cradle-balls-sphere-action-60582.jpeg\",\"large2x\":\"https://images.pexels.com/photos/60582/newton-s-cradle-balls-sphere-action-60582.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=2\\u0026h=650\\u0026w=940\",\"large\":\"https://images.pexels.com/photos/60582/newton-s-cradle-balls-sphere-action-60582.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=650\\u0026w=940\",\"medium\":\"https://images.pexels.com/photos/60582/newton-s-cradle-balls-sphere-action-60582.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=350\",\"small\":\"https://images.pexels.com/photos/60582/newton-s-cradle-balls-sphere-action-60582.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=130\",\"portrait\":\"https://images.pexels.com/photos/60582/newton-s-cradle-balls-sphere-action-60582.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=1200\\u0026w=800\",\"landscape\":\"https://images.pexels.com/photos/60582/newton-s-cradle-balls-sphere-action-60582.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=627\\u0026w=1200\",\"tiny\":\"https://images.pexels.com/photos/60582/newton-s-cradle-balls-sphere-action-60582.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=1\\u0026fit=crop\\u0026h=200\\u0026w=280\"},\"liked\":false,\"alt\":\"Gray Newton's Cradle in Close-up Photogaphy\"},{\"id\":356040,\"width\":5184,\"height\":3456,\"url\":\"https://www.pexels.com/photo/men-s-white-dress-shirt-356040/\",\"photographer\":\"Pixabay\",\"photographer_url\":\"https://www.pexels.com/@pixabay\",\"photographer_id\":2659,\"avg_color\":\"#7B7C7B\",\"src\":{\"original\":\"https://images.pexels.com/photos/356040/pexels-photo-356040.jpeg\",\"large2x\":\"https://images.pexels.com/photos/356040/pexels-photo-356040.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=2\\u0026h=650\\u0026w=940\",\"large\":\"https://images.pexels.com/photos/356040/pexels-photo-356040.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=650\\u0026w=940\",\"medium\":\"https://images.pexels.com/photos/356040/pexels-photo-356040.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=350\",\"small\":\"https://images.pexels.com/photos/356040/pexels-photo-356040.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=130\",\"portrait\":\"https://images.pexels.com/photos/356040/pexels-photo-356040.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=1200\\u0026w=800\",\"landscape\":\"https://images.pexels.com/photos/356040/pexels-photo-356040.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=627\\u0026w=1200\",\"tiny\":\"https://images.pexels.com/photos/356040/pexels-photo-356040.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=1\\u0026fit=crop\\u0026h=200\\u0026w=280\"},\"liked\":false,\"alt\":\"Men's White Dress Shirt\"},{\"id\":1366942,\"width\":5184,\"height\":3456,\"url\":\"https://www.pexels.com/photo/photo-of-clear-glass-measuring-cup-lot-1366942/\",\"photographer\":\"Rodolfo Clix\",\"photographer_url\":\"https://www.pexels.com/@rodolfoclix\",\"photographer_id\":328238,\"avg_color\":\"#222322\",\"src\":{\"original\":\"https://images.pexels.com/photos/1366942/pexels-photo-1366942.jpeg\",\"large2x\":\"https://images.pexels.com/photos/1366942/pexels-photo-1366942.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=2\\u0026h=650\\u0026w=940\",\"large\":\"https://images.pexels.com/photos/1366942/pexels-photo-1366942.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=650\\u0026w=940\",\"medium\":\"https://images.pexels.com/photos/1366942/pexels-photo-1366942.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=350\",\"small\":\"https://images.pexels.com/photos/1366942/pexels-photo-1366942.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=130\",\"portrait\":\"https://images.pexels.com/photos/1366942/pexels-photo-1366942.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=1200\\u0026w=800\",\"landscape\":\"https://images.pexels.com/photos/1366942/pexels-photo-1366942.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=627\\u0026w=1200\",\"tiny\":\"https://images.pexels.com/photos/1366942/pexels-photo-1366942.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=1\\u0026fit=crop\\u0026h=200\\u0026w=280\"},\"liked\":false,\"alt\":\"Photo of Clear Glass Measuring Cup Lot\"},{\"id\":954585,\"width\":5184,\"height\":3456,\"url\":\"https://www.pexels.com/photo/two-test-tubes-954585/\",\"photographer\":\"Martin Lopez\",\"photographer_url\":\"https://www.pexels.com/@mediocrememories\",\"photographer_id\":348411,\"avg_color\":\"#B8AEA3\",\"src\":{\"original\":\"https://images.pexels.com/photos/954585/pexels-photo-954585.jpeg\",\"large2x\":\"https://images.pexels.com/photos/954585/pexels-photo-954585.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=2\\u0026h=650\\u0026w=940\",\"large\":\"https://images.pexels.com/photos/954585/pexels-photo-954585.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=650\\u0026w=940\",\"medium\":\"https://images.pexels.com/photos/954585/pexels-photo-954585.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=350\",\"small\":\"https://images.pexels.com/photos/954585/pexels-photo-954585.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=130\",\"portrait\":\"https://images.pexels.com/photos/954585/pexels-photo-954585.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=1200\\u0026w=800\",\"landscape\":\"https://images.pexels.com/photos/954585/pexels-photo-954585.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=627\\u0026w=1200\",\"tiny\":\"https://images.pexels.com/photos/954585/pexels-photo-954585.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=1\\u0026fit=crop\\u0026h=200\\u0026w=280\"},\"liked\":false,\"alt\":\"Two Test Tubes\"},{\"id\":256381,\"width\":4256,\"height\":2832,\"url\":\"https://www.pexels.com/photo/high-angle-view-of-a-man-256381/\",\"photographer\":\"Pixabay\",\"photographer_url\":\"https://www.pexels.com/@pixabay\",\"photographer_id\":2659,\"avg_color\":\"#2D5F81\",\"src\":{\"original\":\"https://images.pexels.com/photos/256381/pexels-photo-256381.jpeg\",\"large2x\":\"https://images.pexels.com/photos/256381/pexels-photo-256381.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=2\\u0026h=650\\u0026w=940\",\"large\":\"https://images.pexels.com/photos/256381/pexels-photo-256381.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=650\\u0026w=940\",\"medium\":\"https://images.pexels.com/photos/256381/pexels-photo-256381.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=350\",\"small\":\"https://images.pexels.com/photos/256381/pexels-photo-256381.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=130\",\"portrait\":\"https://images.pexels.com/photos/256381/pexels-photo-256381.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=1200\\u0026w=800\",\"landscape\":\"https://images.pexels.com/photos/256381/pexels-photo-256381.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=627\\u0026w=1200\",\"tiny\":\"https://images.pexels.com/photos/256381/pexels-photo-256381.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=1\\u0026fit=crop\\u0026h=200\\u0026w=280\"},\"liked\":false,\"alt\":\"High Angle View of A Man\"},{\"id\":220989,\"width\":5184,\"height\":3456,\"url\":\"https://www.pexels.com/photo/water-bubbles-220989/\",\"photographer\":\"Pixabay\",\"photographer_url\":\"https://www.pexels.com/@pixabay\",\"photographer_id\":2659,\"avg_color\":\"#925D3C\",\"src\":{\"original\":\"https://images.pexels.com/photos/220989/pexels-photo-220989.jpeg\",\"large2x\":\"https://images.pexels.com/photos/220989/pexels-photo-220989.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=2\\u0026h=650\\u0026w=940\",\"large\":\"https://images.pexels.com/photos/220989/pexels-photo-220989.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=650\\u0026w=940\",\"medium\":\"https://images.pexels.com/photos/220989/pexels-photo-220989.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=350\",\"small\":\"https://images.pexels.com/photos/220989/pexels-photo-220989.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026h=130\",\"portrait\":\"https://images.pexels.com/photos/220989/pexels-photo-220989.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=1200\\u0026w=800\",\"landscape\":\"https://images.pexels.com/photos/220989/pexels-photo-220989.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026fit=crop\\u0026h=627\\u0026w=1200\",\"tiny\":\"https://images.pexels.com/photos/220989/pexels-photo-220989.jpeg?auto=compress\\u0026cs=tinysrgb\\u0026dpr=1\\u0026fit=crop\\u0026h=200\\u0026w=280\"},\"liked\":false,\"alt\":\"Water Bubbles\"}],\"total_results\":5705,\"next_page\":\"https://api.pexels.com/v1/search/?page=2\\u0026per_page=10\\u0026query=science\"}";
        ResponseEntity<String> response = new ResponseEntity<>(mockApiResponse, HttpStatus.OK);
        when(mockRestTemplate.exchange(any(String.class), eq(HttpMethod.GET), any(HttpEntity.class), eq(String.class)))
            .thenReturn(response);

        String actual = bestImageRepository.find();

        assertEquals(mockApiResponse, actual);
    }

    @Test
    public void testFind_ReturnsNull_WhenApiResponseIsUnsuccessful() {
        ResponseEntity<String> response = new ResponseEntity<>(HttpStatus.NOT_FOUND);
        when(mockRestTemplate.exchange(any(String.class), eq(HttpMethod.GET), any(HttpEntity.class), eq(String.class)))
            .thenReturn(response);

        String result = bestImageRepository.find();

        assertNull(result);
    }

    @Test
    public void testFind_ReturnsNull_WhenRestTemplateExchangeThrowsException() {
        when(mockRestTemplate.exchange(any(String.class), eq(HttpMethod.GET), any(HttpEntity.class), eq(String.class)))
            .thenThrow(new HttpClientErrorException(HttpStatus.BAD_REQUEST));

        String result = bestImageRepository.find();

        assertNull(result);
    }
}
